{"version":3,"file":"block_index.min.js","sources":["../src/block_index.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Javascript to initialise the opencast block.\n *\n * @module     block_opencast\n * @copyright  2021 Tamara Gunkel, University of MÃ¼nster\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/modal_factory', 'core/modal_events', 'core/str', 'core/url', 'core/notification'],\n    function($, ModalFactory, ModalEvents, str, url, Notification) {\n\n        var initWorkflowModal = function(ocinstanceid, courseid, langstrings) {\n            if (document.getElementById('workflowsjson')) {\n                var workflows = JSON.parse($('#workflowsjson').text());\n\n                $('.start-workflow').on('click', function(e) {\n                    e.preventDefault();\n                    var clickedVideo = $(e.currentTarget);\n                    var select = '<select class=\"custom-select mb-3\" id=\"workflowselect\" name=\"workflow\">';\n\n                    for (let workflow in workflows) {\n                        select += '<option value=\"' + workflow + '\">' + workflows[workflow].title + '</option>';\n                    }\n\n                    select += '</select>';\n\n                    ModalFactory.create({\n                        type: ModalFactory.types.SAVE_CANCEL,\n                        title: langstrings[5],\n                        body: '<form id=\"startWorkflowForm\" method=\"post\" action=\"' +\n                            url.relativeUrl('blocks/opencast/startworkflow.php', {\n                                'ocinstanceid': ocinstanceid,\n                                'courseid': courseid,\n                                'videoid': clickedVideo.data('id')\n                            }) + '\"><div class=\"form-group\">' +\n                            '<p>' + langstrings[6] + '</p>' + select + '<div id=\"workflowdesc\"></div>' +\n                            '<iframe id=\"config-frame\" class=\"w-100 mh-100 border-0\" sandbox=\"allow-forms allow-scripts\" src=\"\">' +\n                            '</iframe><input type=\"hidden\" name=\"configparams\" id=\"configparams\"></form>'\n                    }, undefined)\n                        .then(function(modal) {\n                            modal.setSaveButtonText(langstrings[5]);\n                            var root = modal.getRoot();\n                            root.on(ModalEvents.save, function(e) {\n                                document.getElementById('config-frame').contentWindow.postMessage('getdata', '*');\n                                // Handle form submission after receiving data.\n                                e.preventDefault();\n                            });\n\n                            // Show description for initial value.\n                            modal.show().then(function() {\n                                const workflowselect = $('#workflowselect');\n                                $('#workflowdesc').html(workflows[workflowselect.val()].description);\n                                $('#config-frame').attr('src', url.relativeUrl('blocks/opencast/serveworkflowconfigpanel.php', {\n                                    'ocinstanceid': ocinstanceid,\n                                    'courseid': courseid,\n                                    'workflowid': workflowselect.val()\n                                }));\n\n                                // Show workflow description when selected.\n                                workflowselect.change(function() {\n                                    let workflowid = $(this).val();\n                                    $('#workflowdesc').html(workflows[workflowid].description);\n                                    $('#config-frame').attr('src', url.relativeUrl('blocks/opencast/serveworkflowconfigpanel.php', {\n                                        'ocinstanceid': ocinstanceid,\n                                        'courseid': courseid,\n                                        'workflowid': workflowid\n                                    }));\n                                });\n                                return;\n                            }).catch(Notification.exception);\n                            return;\n                        }).catch(Notification.exception);\n                });\n            }\n        };\n\n        var initReportModal = function(ocinstanceid, courseid, langstrings) {\n            $('.report-problem').on('click', function(e) {\n                e.preventDefault();\n                var clickedVideo = $(e.currentTarget);\n                ModalFactory.create({\n                    type: ModalFactory.types.SAVE_CANCEL,\n                    title: langstrings[0],\n                    body: '<form id=\"reportProblemForm\" method=\"post\" action=\"' +\n                        url.relativeUrl('blocks/opencast/reportproblem.php', {\n                            'ocinstanceid': ocinstanceid,\n                            'courseid': courseid,\n                            'videoid': clickedVideo.data('id')\n                        }) + '\"><div class=\"form-group\">' +\n                        '<label for=\"inputMessage\">' + langstrings[1] + '</label>' +\n                        '<textarea class=\"form-control\" id=\"inputMessage\" name=\"inputMessage\" rows=\"4\" placeholder=\"' +\n                        langstrings[2] + '\">' + '</textarea>' +\n                        '  <div class=\"invalid-feedback d-none\" id=\"messageValidation\">' + langstrings[3] + '</div>' +\n                        '</div></form>'\n                })\n                    .then(function(modal) {\n                        modal.setSaveButtonText(langstrings[4]);\n                        var root = modal.getRoot();\n                        root.on(ModalEvents.save, function(e) {\n                            if ($('#inputMessage').val()) {\n                                $('#reportProblemForm').submit();\n                            } else {\n                                $('#inputMessage').addClass('is-invalid');\n                                $('#messageValidation').removeClass('d-none');\n                            }\n                            e.preventDefault();\n                        });\n                        modal.show();\n                        return;\n                    }).catch(Notification.exception);\n            });\n        };\n\n        /*\n         * Initialise all of the modules for the opencast block.\n         */\n        var init = function(courseid, ocinstanceid) {\n            // Load strings\n            var strings = [\n                {\n                    key: 'reportproblem_modal_title',\n                    component: 'block_opencast'\n                },\n                {\n                    key: 'reportproblem_modal_body',\n                    component: 'block_opencast'\n                },\n                {\n                    key: 'reportproblem_modal_placeholder',\n                    component: 'block_opencast'\n                },\n                {\n                    key: 'reportproblem_modal_required',\n                    component: 'block_opencast'\n                },\n                {\n                    key: 'reportproblem_modal_submit',\n                    component: 'block_opencast'\n                },\n                {\n                    key: 'startworkflow',\n                    component: 'block_opencast'\n                },\n                {\n                    key: 'startworkflow_modal_body',\n                    component: 'block_opencast'\n                }\n            ];\n            str.get_strings(strings).then(function(results) {\n                initWorkflowModal(ocinstanceid, courseid, results);\n                initReportModal(ocinstanceid, courseid, results);\n                return;\n            }).catch(Notification.exception);\n            window.addEventListener('message', function(event) {\n                if (event.origin !== \"null\") {\n                    return;\n                }\n\n                if (event.data === parseInt(event.data)) {\n                    $('#config-frame').height(event.data);\n                } else {\n                    $('#configparams').val(event.data);\n                    $('#startWorkflowForm').submit();\n                }\n            });\n        };\n\n        return {\n            init: init\n        };\n    });\n\n"],"names":["define","$","ModalFactory","ModalEvents","str","url","Notification","init","courseid","ocinstanceid","get_strings","key","component","then","results","langstrings","document","getElementById","workflows","JSON","parse","text","on","e","preventDefault","clickedVideo","currentTarget","select","workflow","title","create","type","types","SAVE_CANCEL","body","relativeUrl","data","undefined","modal","setSaveButtonText","getRoot","save","contentWindow","postMessage","show","workflowselect","html","val","description","attr","change","workflowid","this","catch","exception","initWorkflowModal","submit","addClass","removeClass","initReportModal","window","addEventListener","event","origin","parseInt","height"],"mappings":"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"}